<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Supabase Deposit Address Test</title>
    <style>
      body { font-family: system-ui, Arial; max-width: 820px; margin: 24px auto; padding: 0 12px; }
      .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin: 12px 0; }
      input { width: 100%; padding: 10px; margin: 6px 0 10px; border: 1px solid #ccc; border-radius: 10px; }
      button { padding: 10px 14px; border: 1px solid #333; border-radius: 10px; background: #111; color: #fff; cursor: pointer; }
      button:disabled { opacity: .5; cursor: not-allowed; }
      pre { background: #0b0b0b; color: #d7ffd7; padding: 12px; border-radius: 12px; overflow: auto; }
      .row { display:flex; gap:10px; flex-wrap:wrap; }
      .row > * { flex: 1; min-width: 220px; }
      .ok { color: #0a7a0a; font-weight: 600; }
      .bad { color: #b00020; font-weight: 600; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    </style>
  </head>
  <body>
    <h2>Supabase Deposit Address Test</h2>

    <div class="card">
      <div class="row">
        <div>
          <label>Supabase URL</label>
          <input id="url" class="mono" />
        </div>
        <div>
          <label>Anon key</label>
          <input id="anon" class="mono" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Email</label>
          <input id="email" placeholder="test@test.com" />
        </div>
        <div>
          <label>Password</label>
          <input id="pass" type="password" placeholder="********" />
        </div>
      </div>

      <div class="row">
        <button id="btnLogin">Login</button>
        <button id="btnGet" disabled>Get deposit address</button>
        <button id="btnLogout" disabled>Logout</button>
      </div>

      <p id="status" class="mono"></p>
      <pre id="outRemember"></pre>
    </div>

    <div class="card">
      <h3>Result</h3>
      <div id="result"></div>
      <pre id="out"></pre>
    </div>

    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

      const $ = (id) => document.getElementById(id);
      const statusEl = $("status");
      const outEl = $("out");
      const resultEl = $("result");
      const rememberEl = $("outRemember");

      // Prefill your values (safe: URL + ANON only)
      $("url").value = "https://unxdhdwatwvfokrsdpqg.supabase.co";
      $("anon").value = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVueGRoZHdhdHd2Zm9rcnNkcHFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwOTU1NDcsImV4cCI6MjA4MTY3MTU0N30.SzmdJGRBF4vhigSpz5v8YcrA4DvUYQ8y9GYhMeNeQYU";

      let supabase = null;

      const setStatus = (ok, msg) => {
        statusEl.className = ok ? "ok mono" : "bad mono";
        statusEl.textContent = msg;
      };

      const log = (obj) => {
        outEl.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
      };

      const showAddress = (address) => {
        resultEl.innerHTML = `
          <div class="mono"><b>Deposit address:</b> ${address}</div>
          <div class="mono" style="margin-top:6px;opacity:.8">Network: BNB Chain (BSC)</div>
        `;
      };

      const buildClient = () => {
        const url = $("url").value.trim();
        const anon = $("anon").value.trim();
        if (!url || !anon) throw new Error("Missing URL or anon key");
        supabase = createClient(url, anon);
        rememberEl.textContent = "Client initialized.";
      };

      $("btnLogin").onclick = async () => {
        try {
          buildClient();
          const email = $("email").value.trim();
          const password = $("pass").value;
          if (!email || !password) return setStatus(false, "Missing email or password");

          setStatus(true, "Logging in...");
          const { data, error } = await supabase.auth.signInWithPassword({ email, password });
          if (error) return setStatus(false, "Login error: " + error.message);

          setStatus(true, "Login OK. user_id=" + data.user.id);
          $("btnGet").disabled = false;
          $("btnLogout").disabled = false;
          log({ login: "ok", user_id: data.user.id });
        } catch (e) {
          setStatus(false, String(e?.message || e));
        }
      };

      $("btnGet").onclick = async () => {
        try {
          setStatus(true, "Calling function...");
          const { data, error } = await supabase.functions.invoke("get-deposit-address");
          if (error) return setStatus(false, "Function error: " + error.message);

          if (!data?.address) return setStatus(false, "No address returned");
          setStatus(true, "Address generated/fetched OK");
          showAddress(data.address);
          log(data);
        } catch (e) {
          setStatus(false, String(e?.message || e));
        }
      };

      $("btnLogout").onclick = async () => {
        if (!supabase) return;
        await supabase.auth.signOut();
        $("btnGet").disabled = true;
        $("btnLogout").disabled = true;
        setStatus(true, "Logged out");
        log({ logout: "ok" });
        resultEl.innerHTML = "";
      };
    </script>
  </body>
</html>
